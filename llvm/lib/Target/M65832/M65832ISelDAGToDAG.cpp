//===-- M65832ISelDAGToDAG.cpp - A dag to dag inst selector for M65832 ----===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
// This file defines an instruction selector for the M65832 target.
//
//===----------------------------------------------------------------------===//

#include "M65832.h"
#include "M65832TargetMachine.h"
#include "llvm/CodeGen/MachineFrameInfo.h"
#include "llvm/CodeGen/MachineFunction.h"
#include "llvm/CodeGen/MachineInstrBuilder.h"
#include "llvm/CodeGen/MachineRegisterInfo.h"
#include "llvm/CodeGen/SelectionDAG.h"
#include "llvm/CodeGen/SelectionDAGISel.h"
#include "llvm/IR/CallingConv.h"
#include "llvm/IR/Constants.h"
#include "llvm/IR/DerivedTypes.h"
#include "llvm/IR/Function.h"
#include "llvm/IR/Intrinsics.h"
#include "llvm/Support/Debug.h"
#include "llvm/Support/ErrorHandling.h"
#include "llvm/Support/raw_ostream.h"

using namespace llvm;

#define DEBUG_TYPE "m65832-isel"
#define PASS_NAME "M65832 DAG->DAG Pattern Instruction Selection"

namespace {
class M65832DAGToDAGISel : public SelectionDAGISel {
  const M65832Subtarget *Subtarget = nullptr;

public:
  M65832DAGToDAGISel() = delete;

  explicit M65832DAGToDAGISel(M65832TargetMachine &TM, CodeGenOptLevel OptLevel)
      : SelectionDAGISel(TM, OptLevel) {}

  bool runOnMachineFunction(MachineFunction &MF) override {
    Subtarget = &MF.getSubtarget<M65832Subtarget>();
    return SelectionDAGISel::runOnMachineFunction(MF);
  }

  void Select(SDNode *N) override;

  bool selectAddr(SDValue N, SDValue &Base, SDValue &Offset);

// Include the pieces autogenerated from the target description.
#include "M65832GenDAGISel.inc"

private:
  bool selectFrameIndex(SDNode *N);
};

class M65832DAGToDAGISelLegacy : public SelectionDAGISelLegacy {
public:
  static char ID;
  M65832DAGToDAGISelLegacy(M65832TargetMachine &TM, CodeGenOptLevel OptLevel)
      : SelectionDAGISelLegacy(
            ID, std::make_unique<M65832DAGToDAGISel>(TM, OptLevel)) {}
};

} // end anonymous namespace

char M65832DAGToDAGISelLegacy::ID = 0;

void M65832DAGToDAGISel::Select(SDNode *N) {
  // If we have a custom node, we've already selected it
  if (N->isMachineOpcode()) {
    LLVM_DEBUG(dbgs() << "== "; N->dump(CurDAG); dbgs() << '\n');
    N->setNodeId(-1);
    return;
  }

  // Handle special cases
  switch (N->getOpcode()) {
  case ISD::FrameIndex:
    if (selectFrameIndex(N))
      return;
    break;
  }

  // Select the default instruction
  SelectCode(N);
}

bool M65832DAGToDAGISel::selectFrameIndex(SDNode *N) {
  SDLoc DL(N);
  int FI = cast<FrameIndexSDNode>(N)->getIndex();
  SDValue TFI = CurDAG->getTargetFrameIndex(FI, MVT::i32);
  SDValue Zero = CurDAG->getTargetConstant(0, DL, MVT::i32);
  
  // Use LEA_FI pseudo to load address from frame index
  // This will be handled by eliminateFrameIndex which replaces FI with SP+offset
  ReplaceNode(N, CurDAG->getMachineNode(M65832::LEA_FI, DL, MVT::i32, TFI, Zero));
  return true;
}

bool M65832DAGToDAGISel::selectAddr(SDValue N, SDValue &Base, SDValue &Offset) {
  if (N.getOpcode() == ISD::FrameIndex) {
    Base = CurDAG->getTargetFrameIndex(
        cast<FrameIndexSDNode>(N)->getIndex(), MVT::i32);
    Offset = CurDAG->getTargetConstant(0, SDLoc(N), MVT::i32);
    return true;
  }

  if (N.getOpcode() == ISD::ADD) {
    if (ConstantSDNode *CN = dyn_cast<ConstantSDNode>(N.getOperand(1))) {
      Base = N.getOperand(0);
      Offset = CurDAG->getTargetConstant(CN->getZExtValue(), SDLoc(N), MVT::i32);
      return true;
    }
  }

  Base = N;
  Offset = CurDAG->getTargetConstant(0, SDLoc(N), MVT::i32);
  return true;
}

/// Create the M65832 instruction selector pass
FunctionPass *llvm::createM65832ISelDag(M65832TargetMachine &TM,
                                          CodeGenOptLevel OptLevel) {
  return new M65832DAGToDAGISelLegacy(TM, OptLevel);
}
